---
layout: default
title: 運用・監視・セキュリティ詳細
---

← [トップに戻る](/)

# 運用・監視・セキュリティ詳細

---

## 💾 バックアップ・DR戦略

### バックアップ体系

**3層バックアップ構成**
1. **ZFS スナップショット**（VM/CT の HA 対応）
   - 重要コンテナ：15分〜2時間毎
   - ノード間レプリケーション（pvecore ⇄ pve1 ⇄ pve2）
2. **Proxmox 標準バックアップ**（TrueNAS へ）
3. **TrueNAS ZFS レプリケーション**（メインNAS → サブNAS）

### VM/CT バックアップスケジュール

| バックアップ種別 | 頻度           | 保持期間 | 対象                            | 保存先  |
| ---------------- | -------------- | -------- | ------------------------------- | ------- |
| **日次**         | 月〜金 AM2:00  | 3日      | 全VM/CT（TrueNAS/OPNsense除く） | TrueNAS |
| **日次（サブ）** | 月〜金 AM3:00  | 7日      | 全VM/CT（サブNAS/サブOPN除く）  | サブNAS |
| **週次**         | 土曜 AM2:00    | 2週間    | 全VM/CT（テスト環境除く）       | TrueNAS |
| **週次（サブ）** | 土曜 AM3:00    | 3週間    | 全VM/CT（テスト環境除く）       | サブNAS |
| **月次**         | 第1日曜 AM4:00 | 2ヶ月    | 本番環境のみ                    | TrueNAS |
| **月次（サブ）** | 第1日曜 AM5:00 | 3ヶ月    | 本番環境のみ                    | サブNAS |

**特徴**
- スナップショットモード（Proxmox 標準機能）
- ZSTD 圧縮による容量最適化
- 重複排除のため日次と週次をスケジュール調整

### TrueNAS レプリケーション

- **メインNAS → サブNAS** への自動同期
- 日次 / 週次 / 月次の3世代管理
- 異なるノード間でのデータ保全（ノード障害対策）

### 災害復旧指標

- **RPO（目標復旧時点）**：24時間以内（日次バックアップ）
- **RTO（目標復旧時間）**：2時間以内（手動リストア）
- **バックアップテスト**：月1回、ランダムなVM/CTでリストア検証

---

## 🔍 監視・運用体制

**定期メンテナンス**
- ZFS Scrub：月1回（データ整合性チェック）
- SMART監視：週1回（ディスク健全性確認）
- セキュリティアップデート：週1回
- バックアップリストアテスト：月1回

### 監視ツール：Pulse（Proxmox専用監視）

**監視項目**
- CPU / メモリ / ディスク / ネットワーク使用率
- VM/CT 稼働状況（起動/停止）
- ノード間クラスタ状態
- ストレージ容量・健全性

**アラート通知**
- Discord Webhook による即時通知
- VM/CT ごとにカスタマイズしたしきい値設定

**しきい値設定例**

| VM/CT        | CPU | メモリ | 理由                           |
| ------------ | --- | ------ | ------------------------------ |
| 標準サービス | 80% | 90%    | 通常の負荷監視                 |
| TrueNAS      | -   | 95%    | ZFS がメモリを積極利用するため |
| Nextcloud    | -   | 95%    | snap のキャッシュ挙動を考慮    |
| Immich       | -   | 95%    | Docker のキャッシュ挙動を考慮  |

---

## 🔒 セキュリティ対策

### ネットワークセキュリティ

**ゼロトラストアーキテクチャ**
- 6つのセグメント（VXLAN）による完全分離
- セグメント間は原則通信不可
- 必要な通信のみポート/IP単位で許可

**ファイアウォール階層**
1. OPNsense：セグメント間ルーティング・ファイアウォール
2. Proxmox Datacenter：ノード間通信制御
3. 各VM/CT：個別のファイアウォール設定

### 認証・暗号化

- **TLS 1.3**：ほぼ全サービスでTLS通信を強制
- **SSH**：公開鍵認証のみ（パスワード認証無効化）
- **2FA**：ProxmoxVE管理画面 / TrueNAS などで二要素認証を有効化
- **VPN**：WireGuard による暗号化リモートアクセス

### 証明書管理

- **内部サービス**：Step-CA（プライベートCA）によるACME自動更新
- **外部互換性が必要なサービス**：Let's Encrypt（DNS-01チャレンジ）
- Step-CA 証明書有効期限：30日（自動更新）

### アクセス制御

- 管理セグメント（10.0.10.0/24）は VPN 経由およびOPNsense LANからのみアクセス可
- Proxmox 管理画面は物理LAN（192.168.0.0/24）、VPN 経由およびOPNsense LANからのみアクセス可
- 外部公開サービスは専用セグメント（10.0.50.0/24）に隔離

---

## 🔥 障害対応・トラブルシューティング例

### 1. Proxmox ノードが正常にシャットダウンできない

**症状**：特定ノードでBIOS不具合によりシャットダウン失敗で、強制停止が必要になる  
**原因**：

- BIOS相性問題によりでデバイス切離に失敗  
- BIOS不具合により設定が正しく適用されない  

**対策**：不具合を回避したBIOS設定の見直し  
**結果**：安定した停止処理を実現、ノード再起動の信頼性向上

### 2. Proxmox → TrueNAS（NFS）バックアップ失敗

**症状**：特定コンテナのバックアップ時にハング、他のバックアップも影響を受ける  
**原因**：コンテナのストレージ移動時に `.conf` ファイルが破損（`[vzdump]` セクション残存）  
**対策**：設定ファイルの手動修正で `rootfs` 定義を正規化  
**学び**：コンテナ設定の整合性確認の重要性、バックアップ前の検証手順確立

### 3. Immich Docker が高メモリ使用でアラート

**症状**：メモリ使用率95%超え、でPulseからのアラート発生  
**原因**：Docker / snap のキャッシュ挙動によるメモリ消費  
**対策**：Pulse 監視でしきい値を調整（実際のメモリ圧迫ではないと判断）   
**学び**：メモリ使用率の表面的な数値だけでなく、実際の圧迫状況を見極める重要性

---

← [トップに戻る](/)
